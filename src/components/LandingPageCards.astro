---
import TagLineChanger from './TagLineChanger.astro';
import { baseHost } from '../utils/utilities.ts';
---

<div class="outer-container">
    <div class="landing-page-cards" data-base-host={baseHost}>
        <div class="info-item">
            <div class="image-container" data-card="0">
                <img
                    src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                    alt="Beyond the Golden Route"
                    class="info-image"
                />
            </div>
            <div class="dots"></div>
            <h2>Destinations Just Off the Golden Route</h2>
            <p>
                Perhaps you've <span class="emph">already planned the Golden Route</span> - Kyoto, Tokyo, Osaka, maybe even
                Hakone, Takayama, and Kanazawa. These places are great, and <span class="emph"
                    >there's a reason they're crowd favorites</span
                >
                . But you've also wondered what it's like in <span class="emph">the places in between</span> - the quiet
                towns, the back roads, <span class="emph">the parts most travelers miss</span>.
            </p>
        </div>

        <div class="info-item">
            <div class="image-container" data-card="1">
                <img
                    src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                    alt="Journey Through Rural Japan"
                    class="info-image"
                />
            </div>
            <div class="dots"></div>
            <h2>A Journey Through Rural Japan, Designed for You</h2>
            <p>
                <span class="emph first-words">We design flexible countryside itineraries</span> - by bike, on foot, or a
                mix of both - <span class="emph">tailored to your schedule, comfort, and curiosity</span>. Whether <span
                    class="emph">fully guided or just planning and logistics</span
                >, we help turn the space between the famous stops into the <span class="emph"
                    >best part of the trip</span
                >.
            </p>
        </div>

        <div class="info-item">
            <div class="image-container" data-card="2">
                <img
                    src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                    alt="Accessible Rural Japan"
                    class="info-image"
                />
            </div>
            <div class="dots"></div>
            <h2>Accessible Japan Countryside - Without a Car</h2>
            <p>
                Maybe you've been <span class="emph">told you need a car</span> to see the countryside, or in order to get
                "off the beaten path". <span class="emph">You don't</span>. Many <span class="emph"
                    >rural towns are eager and ready for visitors</span
                >, and more accessible than you think - <span class="emph"><em>if</em></span> you know <span
                    class="emph">where to go, how to get there</span
                > and you're willing to slow down.
            </p>
        </div>
    </div>
    <div class="card-nav-buttons">
        <button id="prev-group" class="nav-button nav-left">&laquo;</button>
        <button id="next-group" class="nav-button nav-right">&raquo;</button>
    </div>
</div>

<script is:inline>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.querySelector('.landing-page-cards');
        const baseHost = container.dataset.baseHost || '';
        const cards = Array.from(container.querySelectorAll('.image-container'));
        let allImagePaths = [];
        let predefinedGroups = [];
        let groups = [];
        let currentGroupIndex = 0;
        let scrollTime = 10000;

        // Load all images
        try {
            const res = await fetch('/data/card-image-paths.json');
            allImagePaths = await res.json();
        } catch (error) {
            console.error('Failed to load card-image-paths.json:', error);
            return;
        }

        // Load predefined groups
        try {
            const res = await fetch('/data/card-images-pre-defined.json');
            predefinedGroups = await res.json();
        } catch (error) {
            console.error('Failed to load card-images-pre-defined.json:', error);
            predefinedGroups = [];
        }

        const predefinedFlat = predefinedGroups.flat();
        const randomPool = allImagePaths.map((path) => baseHost + path).filter((url) => !predefinedFlat.includes(url));
        const shuffledRandom = shuffle([...randomPool]);

        // Build groups
        let visitCount = parseInt(localStorage.getItem('landingPageCardsVisitCount') || '0', 10);
        visitCount++;
        localStorage.setItem('landingPageCardsVisitCount', visitCount.toString());

        // Only show predefined groups if visits <= 2
        if (visitCount <= 2) {
            for (const group of predefinedGroups) {
                if (group.length === 3) groups.push(group);
            }
        }

        let available = [...shuffledRandom];
        while (available.length >= 3) {
            const trio = available.splice(0, 3);
            groups.push(trio);
        }

        function showGroup(group) {
            if (!group || group.length !== 3) return;
            group.forEach((imgUrl, idx) => {
                const imgEl = cards[idx]?.querySelector('.info-image');
                if (imgEl) {
                    imgEl.src = imgUrl;
                    imgEl.style.opacity = 1;
                }
            });
        }

        function transitionGroup(group) {
            if (!group || group.length !== 3) return;

            cards.forEach((wrapper, idx) => {
                const imgEl = wrapper.querySelector('.info-image');
                if (!imgEl) return;

                imgEl.style.transition = 'opacity 2s ease-out';
                imgEl.style.opacity = 0;

                imgEl.addEventListener(
                    'transitionend',
                    function onEnd(e) {
                        if (e.propertyName !== 'opacity') return;
                        imgEl.removeEventListener('transitionend', onEnd);

                        const preload = new Image();
                        preload.onload = () => {
                            imgEl.src = group[idx];
                            imgEl.style.transition = 'opacity 0.5s ease-in';
                            imgEl.style.opacity = 1;
                        };
                        preload.src = group[idx];
                    },
                    { once: true },
                );
            });
        }

        function fadeToNext() {
            currentGroupIndex++;
            if (currentGroupIndex >= groups.length) {
                rerandomizeAll();
                currentGroupIndex = 0;
            }
            transitionGroup(groups[currentGroupIndex]);
        }

        function fadeToPrev() {
            currentGroupIndex--;
            if (currentGroupIndex < 0) {
                currentGroupIndex = groups.length - 1;
            }
            transitionGroup(groups[currentGroupIndex]);
        }
        function startAutoScroll() {
            const id = setInterval(fadeToNext, scrollTime);
            window._landingPageCardIntervals.push(id);
        }

        function resetAutoScroll() {
            // Clear all existing timers
            window._landingPageCardIntervals.forEach(clearInterval);
            window._landingPageCardIntervals = [];
            // Start a NEW timer
            const id = setInterval(fadeToNext, scrollTime);
            window._landingPageCardIntervals.push(id);
        }

        function pauseAutoScrollAndResume() {
            window._landingPageCardIntervals.forEach(clearInterval);
            window._landingPageCardIntervals = [];
            clearTimeout(autoResumeTimer);
            autoResumeTimer = setTimeout(() => {
                startAutoScroll();
            }, scrollTime); // 30 seconds pause
        }

        function rerandomizeAll() {
            const combined = predefinedFlat.concat(randomPool);
            let available = shuffle([...combined]);
            groups = [];

            while (available.length >= 3) {
                const trio = available.splice(0, 3); // Take first three and remove them
                groups.push(trio);
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Button handlers
        document.getElementById('next-group')?.addEventListener('click', () => {
            fadeToNext();
            //pauseAutoScrollAndResume();
            resetAutoScroll();
        });
        document.getElementById('prev-group')?.addEventListener('click', () => {
            fadeToPrev();
            //pauseAutoScrollAndResume();
            resetAutoScroll();
        });

        // Start
        window._landingPageCardIntervals = window._landingPageCardIntervals || [];
        let autoResumeTimer = null;
        showGroup(groups[currentGroupIndex]);
        startAutoScroll();
    });
</script>
<!-- 
<style lang="scss">
    @use '../styles/global' as *;

    h2 {
        //border: 1px solid red !important;
        color: var(--bs-primary-ultradark) !important;
        margin-top: 10px;
    }
    .info-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        object-fit: cover;
        margin-bottom: 20px;
        transition: opacity 0.5s ease; /* < -  add this */
        opacity: 1; /* ensure starting at full opacity */
    }
    .info-item {
        position: relative;
        overflow: hidden; /* clip the pseudo */
    }

    .info-item::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: var(--next-image);
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0;
        transition: opacity 0.1s ease;
        z-index: 1;
    }

    .info-item.fade::before {
        opacity: 1;
    }

    .info-image {
        display: block;
        width: 100%;
        height: auto;
        object-fit: cover;
        transition: opacity 0.6s ease;
        position: relative;
        z-index: 0;
        opacity: 1;
    }

    .landing-page-cards {
        display: grid; /* Use CSS Grid */
        grid-template-columns: repeat(3, 1fr); /* 3 columns on large screens */
        gap: 30px;
        margin-top: 40px;
        width: 100%;
        grid-auto-flow: row; /* Ensure items are arranged in rows */
        @include respond-to(small) {
            // padding: 10px;
            // width: 50%;
        }
    }

    /* Style for individual info items */
    .info-item {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .info-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        object-fit: cover;
        margin-bottom: 20px;
    }

    .info-item h2 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }

    .info-item p {
        font-size: 1.1rem;
        color: #666;
        line-height: 1.6;
    }

    /* Responsive Layout */
    @media (max-width: 1200px) {
        .landing-page-cards {
            grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            gap: 20px;
        }
    }

    @media (max-width: 768px) {
        .landing-page-cards {
            grid-template-columns: 1fr; /* 1 column on smaller screens */

            grid-auto-flow: row;
            gap: 15px;
        }

        /* This places the middle card at the top of the grid when on smaller screens */
        .landing-page-cards .info-item:nth-child(2) {
            grid-row: 1; /* Place the second card in the first row */
            grid-auto-flow: row;
        }
    }

    .image-container {
        position: relative;
        /* choose one of these: */

        /* A) Fixed height: */
        height: 250px; /* or whatever constant height you need */
        width: 100%;
        overflow: hidden;

        /*  -  -  -  or  -  -  -  */

        /* B) Aspectâ€ratio (keeps it proportional to width): */
        /* aspect-ratio: 16 / 9; */
        /* width: 100%; */
        /* overflow: hidden; */
    }

    .image-container::before {
        /* no change here except ensure it covers the same area: */
        position: absolute;
        inset: 0;
        background-image: var(--next-image);
        background-size: cover; /* crop to fill */
        background-position: center; /* center the crop */
        background-repeat: no-repeat;
        opacity: 0;
        transition: opacity 0.6s ease;
        z-index: 1;
    }

    .image-container.fade::before {
        opacity: 1;
    }

    .info-image {
        /* fill the container, but crop any overflow */
        width: 100%;
        height: 250px;
        object-fit: cover; /* fill & crop */
        transition: opacity 0.6s ease;
        position: relative;
        z-index: 0;
        opacity: 1;
    }

    .dots {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 2;
    }
    .dot {
        width: 6px;
        height: 6px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.3s;
    }
    .dot.active {
        background: rgba(0, 0, 0, 0.7);
    }
    .outer-container {
        position: relative;
        width: 100%;
    }

    .landing-page-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
        margin-top: 40px;
        width: 100%;
        grid-auto-flow: row;
    }

    .card-nav-buttons {
        position: absolute;
        top: 125px;
        left: 0;
        right: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 10px;
        pointer-events: none; /* allow underlying elements to still be clickable */
        z-index: 10;
    }

    .nav-button {
        pointer-events: auto; /* buttons themselves are clickable */
        background: rgba(0, 0, 0, 0.9);
        border: none;
        color: white;
        font-size: 1.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .nav-button:hover {
        background: rgba(0, 0, 0, 0.6);
    }

    .nav-left {
        margin-left: 2px;
    }

    .nav-right {
        margin-right: 2px;
    }
    .nav-button.nav-left,
    .nav-button.nav-right {
        padding: 4px 6px !important; /* much smaller padding */
        margin: 2px !important; /* small margin */
        width: 25px;
        height: 40px;
        border-radius: 5px;
        font-size: 1.5rem;
        line-height: 1;
        background: rgba(0, 0, 0, 0.1); /* semi-transparent background */
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-button.nav-left:hover,
    .nav-button.nav-right:hover {
        background: rgba(0, 0, 0, 0.6);
    }
    @media (max-width: 768px) {
        .nav-button {
            display: none;
        }
    }
    @include respond-to(large) {
        .landing-page-cards {
            display: grid;
            grid-template-columns: 1fr;
            grid-auto-flow: row;
            gap: 15px;
            justify-items: center; /* optional: center the cards if you want */
            align-items: start; /* optional: align cards properly */
        }

        .image-container {
            height: 350px;
        }
        .info-image {
            height: 350px;
        }
    }
    @include respond-to(small) {
        .landing-page-cards {
            display: grid;
            grid-template-columns: 1fr;
            grid-auto-flow: row;
            gap: 15px;
            justify-items: center; /* optional: center the cards if you want */
            align-items: start; /* optional: align cards properly */
        }
        .image-container {
            height: 275px;
        }
        .info-image {
            height: 275px;
        }
    }
</style> -->
<style lang="scss">
    @use '../styles/global' as *;

    h2 {
        color: var(--bs-primary-ultradark) !important;
        margin-top: 10px;
    }

    .landing-page-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
        margin-top: 40px;
        width: 100%;
        grid-auto-flow: row;

        @include respond-to(large) {
            grid-template-columns: 1fr;
            gap: 15px;
            justify-items: center;
            align-items: start;
        }

        @include respond-to(small) {
            grid-template-columns: 1fr;
            gap: 15px;
            justify-items: center;
            align-items: start;
        }
    }

    /* Info Card */
    .info-item {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;

        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        p {
            font-size: 1.1rem;
            color: #666;
            line-height: 1.6;
        }
    }

    /* Image */
    .image-container {
        position: relative;
        width: 100%;
        height: 250px;
        overflow: hidden;

        @include respond-to(large) {
            height: 350px;
        }

        @include respond-to(small) {
            height: 250px;
        }

        &::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: var(--next-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 0.6s ease;
            z-index: 1;
        }

        &.fade::before {
            opacity: 1;
        }
    }

    .info-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 20px;
        transition: opacity 0.6s ease;
        position: relative;
        z-index: 0;
        opacity: 1;

        @include respond-to(large) {
            height: 350px;
        }

        @include respond-to(small) {
            height: 240px;
        }
    }

    /* Dots */
    .dots {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 2;

        .dot {
            width: 6px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;

            &.active {
                background: rgba(0, 0, 0, 0.7);
            }
        }
    }

    /* Navigation Buttons */
    .outer-container {
        position: relative;
        width: 100%;
    }

    .card-nav-buttons {
        position: absolute;
        top: 125px;
        left: 0;
        right: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 10px;
        pointer-events: none;
        z-index: 10;

        .nav-button {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 25px;
            height: 40px;
            border-radius: 5px;
            margin: 2px;
            padding: 4px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;

            &:hover {
                background: rgba(0, 0, 0, 0.6);
            }
        }

        @media (max-width: 768px) {
            display: none;
        }
    }
</style>
